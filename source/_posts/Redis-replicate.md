---
title: Redis之复制
date: 2016-11-25 15:04:22
tags: Redis
---
本文来学习下Redis中的复制特性。我们知道，在使用多Redis服务器的时候，保持主从服务器间的数据同步（一致性）是一个很重要的问题。
<!--more--> 
### Redis 2.8以前的复制
Redid的复制功能分为同步和命令传播两个操作：    
（1）同步用于将从服务器的数据库状态更新至主服务器当前所处的数据库状态；    
（2）命令传播操作则用于在数据库状态被修改，导致主从服务器的数据库状态不一致时，让主从服务器的数据库状态重新回到一致状态。   
#### 同步
从服务器对主服务器的同步操作需要通过向主服务器发送SYNC命令来完成，其执行步骤是：     
（1）从服务器向主服务器发送SYNC命令。    
（2）收到SYNC命令的主服务器执行BGSAVE命令，在后台生成一个RDB文件，并使用一个缓冲区记录从现在开始执行的所有写命令。    
（3）当主服务器的BGSAVE命令执行完毕时，主服务器会将BGSAVE命令生成的RDB文件发送给从服务器，从服务器接收并载入该RDB文件，将自己的数据库状态更新至主服务器执行BGSAVE命令时的数据库状态。    
（4）主服务器将记录在缓冲区中的所有写命令发送给从服务器，从服务器执行这些写命令，将自己的数据库状态更新至主服务器数据库当前所处的状态。      
#### 命令传播
同步操作执行完毕后，主从服务器两者的数据库达到一致状态，但这种一致并非一成不变的，每当主服务器执行客户端发送的写命令时，主服务器的数据库就有可能会被修改，并导致主服务器状态不再一致。   
因此，为了让主从服务器再次回到一致状态，主服务器需要对服务器执行命令传播操作：主服务器会将自己执行的写命令，也即是造成主从服务器不一致的那条写命令，发送给从服务器执行，当从服务器执行了相同的写命令之后，主从服务器将再次回到一致状态。     
#### Redis 2.8以前的复制存在的问题
Redis 2.8之前的版本对于断线后重新复制支持不好，虽然能够完成任务，但是效率却非常低。
![](http://i.imgur.com/BixE10t.png)![](http://i.imgur.com/PYwhGV3.png)   
从上面的例子可以看出，虽然再次向主服务器发送SYNC命令可以让主从服务器重新回到一致状态，但是，主服务器生成的RDB文件中却包含了键k1至键k10089的RDB文件，而其中k1至k10086的数据对于服务器来说都是不必要的。     

### 新版Redis复制功能的实现
Redis从2.8版本开始，使用PSYNC命令代替SYNC命令来执行复制时的同步操作。而PSYNC命令具有完整重同步和部分重同步。不难想到，完全重同步用于处理初次复制的情况；而部分重同步用于处理断线后重复制的情况。
#### 部分重同步的实现
部分重同步功能由三个部分构成：（1）主服务器和从服务器的复制偏移量；（2）主服务器的复制积压缓冲区；（3）服务器的运行ID。       
1. 执行复制的主从服务器双方会分别维护一个复制偏移量：     
（1）主服务器每次向从服务器传播N个字节的数据时，就将自己的复制偏移量的值加上N；     
（2）从服务器每次收到主服务器传来的N个字节的数据时，将自己的复制偏移量的值加上N。   
从而，通过对比主从服务器的复制偏移量，程序可以很容易地知道主从服务器是否处于抑制状态。   
2. 复制积压缓冲区是主从服务器在进行同步时的一个重要结构。它是由主服务器维护的一个固定长度的FIFO队列，默认大小为1MB。   
当主服务器进行命令传播时，它不仅会将写命令发送给所有从服务器，还会将写命令入队到复制积压缓冲区中。因此，主服务器的复制积压缓冲区里面会保存一部分最近传播的写命令，并且会为每个字节记录相应的复制偏移量。      
所以，当从服务器重新连上主服务器时，从服务器会通过PSYNC命令将自己的复制偏移量offset发送给主服务器，主服务器会根据这个复制偏移量来决定对从服务器执行何种同步操作。
3. 除了上述两部分之外，实现部分重同步操作还需要用到服务器运行ID，每个Redis服务器都拥有自己的运行ID。从而当从服务器对主服务器进行初次复制时，主服务器会将自己的运行ID传送给从服务器，从服务器则会将这个运行ID保存起来。当从服务器断线并重新连上一个主服务器时，从服务器将向当前连接的主服务器发送之前保存的运行ID，主服务器进行对比来判断是执行部分重同步还是完整重同步。    
### 心跳监测
在命令传播阶段，从服务器默认以每秒一次的频率，向主服务器发送命令： `REPLCONF ACK <replication_offset>`，其中replication\_offset是从服务器当前的复制偏移量。   
发送该命令对于主从服务器有三个作用：   
（1）检测主从服务器的网络连接状态。   
（2）辅助实现mini-slaves选项。     
（3）检测命令丢失。    
#### 检测主从服务器的网络连接状态
主从服务器通过发送和接收REPLCONF ACK命令来检查两者之间的网络连接是否正常：如果主服务器超过一秒钟没有收到从服务器发来的REPLCONF ACK命令，那么主服务器就知道主从服务器之间的连接出现问题了。    
#### 辅助实现mini-slaves配置选项
Redis的mini-slaves-to-write和mini-slaves-max-lag两个选项可以防止主服务器在不安全的情况下执行写命令。比如，主服务器有如下配置：
`min-slaves-to-write 3`
`min-slaves-max-lag 10`
那么在从服务器的数量少于3个，或者三个从服务器的延迟值都大于或等于10秒时，主服务器将拒绝执行写命令。    
#### 检测命令丢失
如果因为网络故障，主服务器传播给从服务器的写命令在半路丢失，那么当从服务器向主服务器发送REPLCONF ACK命令时，主服务器将发觉从服务器当前的复制偏移量少于自己的复制偏移量，然后主服务器就会根据从服务器提交的复制偏移量，在复制积压缓冲区里找到从服务器缺少的数据，并将这些数据重新发送给从服务器。  
     

